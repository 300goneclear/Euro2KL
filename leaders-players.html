
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Euro2KLeague — Player Leaders (Multi‑path)</title>
  <link rel="stylesheet" href="stats.css">
</head>
<body>
  <div class="wrapper">
    <div class="header">
      <div class="logo">E2K</div><h1>Stats</h1>
      <div class="subnav">
        <a class="active" href="leaders-players.html">Player Leaders</a>
        <a href="leaders-teams.html">Team Leaders</a>
      </div>
    </div>

    <div id="debug" class="debug" style="display:none"></div>

    <div class="section-title">
      <h2>Game Leaders</h2><span class="badge">AUTO</span>
    </div>
    <div class="grid">
      <div class="leaders" id="player-leaders"></div>
      <aside class="sidebar" id="sidebar-right"></aside>
    </div>

    <footer>Euro2KLeague — multi‑path build • Generated 2025-09-05</footer>
  </div>

<script>

(() => {
  const QS = new URLSearchParams(location.search);
  const DEBUG = QS.has('debug');
  const wrapper = document.querySelector('.wrapper');
  function dbg(msg) { if(!DEBUG) return; const d=document.getElementById('debug'); d.style.display='block'; d.innerHTML += `<div>${msg}</div>`; }
  function showEmpty(where,msg,det) { const div=document.createElement('div'); div.className='empty'; div.innerHTML=`<strong>${msg}</strong>${det?`<div class="kicker">${det}</div>`:''}`; where.appendChild(div); }

  // Allow override via ?box=<path or filename>
  const override = QS.get('box');

  const CANDIDATE_FILES = [
    'boxscores/latest.json',
    'boxscores/current.json',
    'boxscores/boxscore.json',
    'boxscore.json'
  ];
  const BASES = ['/Euro2KL/assets/data','assets/data','/assets/data'];

  function buildCandidates() {
    const urls = [];
    if(override) {
      // Absolute path or url
      if(/^(https?:)?\/\//.test(override)) urls.push(override);
      else {
        // Try as-is and with bases
        urls.push(override.replace(/^\//,''));
        BASES.forEach(b => urls.push(`${b.replace(/\/$/,'')}/${override.replace(/^\//,'')}`));
      }
    }
    BASES.forEach(b => CANDIDATE_FILES.forEach(f => urls.push(`${b.replace(/\/$/,'')}/${f}`)));
    return urls;
  }

  async function fetchFirstJSON(urls) {
    for (const url of urls) {
      try {
        const r = await fetch(url, { cache:'no-store' });
        dbg(`TRY: ${url} → ${r.status}`);
        if (r.ok) return await r.json();
      } catch(e) { dbg(`ERR: ${url} → ${e.message}`); }
    }
    // Optional GitHub fallback: list Euro2KL/assets/data/boxscores and use latest file
    try {
      const owner='300goneclear', repo='300goneclear.github.io', branch='main', dir='Euro2KL/assets/data/boxscores';
      const listUrl=`https://api.github.com/repos/${owner}/${repo}/contents/${dir}?ref=${branch}`;
      const res=await fetch(listUrl, {cache:'no-store'});
      if(res.ok) {
        const files=await res.json();
        const jsons=files.filter(f=>/\.json$/i.test(f.name));
        jsons.sort((a,b)=> (a.name<b.name?1:-1)); // simple filename sort (YYYY-MM-DD-* recommended)
        if(jsons.length) {
          const raw=`https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${dir}/${jsons[0].name}`;
          const r=await fetch(raw, {cache:'no-store'});
          if(r.ok) return await r.json();
        }
      }
    } catch(e) { dbg('GitHub fallback failed: '+e.message); }

    throw new Error('No valid data source found.');
  }

  function renderCard(where, title, rows){
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<h3>${title}</h3><table class="table"><tbody></tbody></table>`;
    const tb=card.querySelector('tbody');
    rows.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="rank">${i+1}.</td><td>${r.name}</td><td style="text-align:right;font-variant-numeric:tabular-nums">${r.val}</td>`; tb.appendChild(tr); });
    where.appendChild(card);
  }
  const by=k=>(a,b)=>(b[k]??0)-(a[k]??0);
  const round=(x,d=1)=> Number.parseFloat(x??0).toFixed(d);

  async function run(){
    const host=document.getElementById('player-leaders');
    let data;
    try {
      const urls = buildCandidates();
      dbg('<b>Candidate URLs:</b><br>'+urls.map(u=>'• '+u).join('<br>'));
      data = await fetchFirstJSON(urls);
    } catch(e) {
      showEmpty(host, 'Couldn’t load a box score from any data path.', e.message);
      return;
    }
    const game = data.game || data;
    const players = [].concat(game.home?.players||[], game.away?.players||[]);
    if(!players.length) { showEmpty(host, 'No player lines found.', 'Expected home.players and away.players arrays.'); return; }

    const cats = [
      ['POINTS','pts',0],
      ['REBOUNDS','reb',0],
      ['ASSISTS','ast',0],
      ['STEALS','stl',0],
      ['BLOCKS','blk',0],
      ['3-PT MADE','tpm',0],
      ['FIELD GOAL %','fg',1, p => (p.fga? (100*(p.fgm||0)/p.fga).toFixed(1)+'%':'—')],
      ['3-PT %','tp',1, p => (p.tpa? (100*(p.tpm||0)/p.tpa).toFixed(1)+'%':'—')],
      ['FREE THROW %','ft',1, p => (p.fta? (100*(p.ftm||0)/p.fta).toFixed(1)+'%':'—')]
    ];
    for(const [label,key,dp,fmt] of cats){
      const top=[...players].sort(by(key)).slice(0,5).map(p=>({ name: p.gamertag||p.name||'—', val: fmt?fmt(p):round(p[key],dp) }));
      renderCard(host, label, top);
    }
  }

  run();
})();

</script>
</body>
</html>
