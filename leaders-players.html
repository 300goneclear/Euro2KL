<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Euro2KLeague — Player Leaders (Season default)</title>
  <link rel="stylesheet" href="stats.css">
</head><body>
<div class="wrapper">
  <div class="header">
    <div class="logo">E2K</div><h1>Stats</h1>
    <div class="subnav"><a class="active" href="leaders-players.html">Player Leaders</a><a href="leaders-teams.html">Team Leaders</a></div>
  </div>
  <div id="debug" class="debug" style="display:none"></div>
  <div class="section-title"><h2>Player Leaders</h2><span class="badge">SEASON (default)</span></div>
  <div class="grid"><div class="leaders" id="player-leaders"></div><aside class="sidebar" id="sidebar-right"></aside></div>
  <footer>Euro2KLeague — aggregates games.json • Generated 2025-09-05</footer>
</div>
<script>
(() => {
  const QS = new URLSearchParams(location.search);
  const DEBUG = QS.has('debug');
  const BASES = ['/Euro2KL/assets/data','assets/data','/assets/data'];

  function dbg(msg){ if(!DEBUG) return; const d=document.getElementById('debug'); d.style.display='block'; d.innerHTML += `<div>${msg}</div>`; }
  function showEmpty(where,msg,det){ const div=document.createElement('div'); div.className='empty'; div.innerHTML = `<strong>${msg}</strong>${det?`<div class="kicker">${det}</div>`:''}`; where.appendChild(div); }

  async function fetchAny(file){
    for(const base of BASES){
      const url = `${base.replace(/\/$/,'')}/${file.replace(/^\//,'')}`;
      try{ const r = await fetch(url, {cache:'no-store'}); dbg(`TRY ${url} → ${r.status}`); if(r.ok) return await r.json(); } catch(e){ dbg(`ERR ${url} → ${e.message}`); }
    }
    throw new Error('No file found: '+file);
  }

  function aggregatePlayersFromGames(games){
    const map = new Map();
    games.forEach(g=>{
      const H = g.home || {}; const A = g.away || {};
      [ [H,'HOME'], [A,'AWAY'] ].forEach(([team,side])=>{
        (team.players||[]).forEach(p=>{
          const id = p.gamertag || p.name || p.playerName || p.id || JSON.stringify(p);
          if(!map.has(id)) map.set(id, { id, name: p.gamertag||p.name||p.playerName||'—', team: team.name||team.id||'Unknown', gp:0, pts:0, reb:0, ast:0, stl:0, blk:0, tpm:0 });
          const rec = map.get(id);
          rec.gp += 1;
          rec.pts += Number(p.pts||0); rec.reb += Number(p.reb||0); rec.ast += Number(p.ast||0); rec.stl += Number(p.stl||0); rec.blk += Number(p.blk||0);
          rec.tpm += Number(p.tpm||0);
        });
      });
    });
    // compute per-game averages
    const arr = [...map.values()].map(r=> ({ ...r,
      ppg: r.gp? (r.pts / r.gp) : 0,
      rpg: r.gp? (r.reb / r.gp) : 0,
      apg: r.gp? (r.ast / r.gp) : 0,
      spg: r.gp? (r.stl / r.gp) : 0,
      bpg: r.gp? (r.blk / r.gp) : 0,
      tpm_pg: r.gp? (r.tpm / r.gp) : 0
    }));
    return arr;
  }

  function renderCard(where, title, rows){
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<h3>${title}</h3><table class="table"><tbody></tbody></table>`;
    const tb=card.querySelector('tbody');
    rows.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td class="rank">${i+1}.</td><td>${r.name}</td><td style="text-align:right;font-variant-numeric:tabular-nums">${r.val}</td>`; tb.appendChild(tr); });
    where.appendChild(card);
  }
  const by=k=>(a,b)=>(b[k]??0)-(a[k]??0);
  const round=(x,d=1)=> Number.parseFloat(x??0).toFixed(d);

  async function run(){
    const host=document.getElementById('player-leaders');
    const mode = (QS.get('mode') || 'season').toLowerCase(); // default SEASON
    let games = [];
    try{
      const raw = await fetchAny('games.json');
      games = Array.isArray(raw)? raw : (raw.games || raw.data || []);
      dbg(`Loaded games.json (${games.length} entries)`);
    }catch(e){
      dbg('games.json not found or empty; will try boxscore.json fallback');
    }

    if(mode === 'game'){
      // game mode: choose specific game by ?game=ID or fallback to first entry in games[], else fallback to boxscore.json
      let chosen = null;
      const gameId = QS.get('game');
      if(games.length){
        if(gameId) chosen = games.find(g => String(g.game_id||g.id) === gameId);
        if(!chosen) chosen = games[0]; // first in file (not "most recent" by default)
      }
      if(!chosen){
        try{ const box = await fetchAny('boxscore.json'); chosen = box.game || box; dbg('Loaded boxscore.json as game-mode fallback'); }
        catch(e){ showEmpty(host,'No game found for game-mode','Upload games.json or boxscore.json'); return; }
      }
      const players = [].concat(chosen.home?.players||[], chosen.away?.players||[]);
      if(!players.length){ showEmpty(host,'No player lines in chosen game.','Expected home.players + away.players'); return; }
      const cats = [['POINTS','pts',0],['REBOUNDS','reb',0],['ASSISTS','ast',0],['STEALS','stl',0],['BLOCKS','blk',0],['3-PT MADE','tpm',0],['FIELD GOAL %','fg',1,p=>p.fga?(100*(p.fgm||0)/p.fga).toFixed(1)+'%':'—'],['3-PT %','tp',1,p=>p.tpa?(100*(p.tpm||0)/p.tpa).toFixed(1)+'%':'—']];
      for(const [label,key,dp,fmt] of cats){ const top=[...players].sort(by(key)).slice(0,5).map(p=>({name:p.gamertag||p.name||'—', val: fmt?fmt(p):round(p[key],dp)})); renderCard(host,label,top); }
      return;
    }

    // season mode (default): aggregate across games.json; if none, fallback to boxscore.json single
    if(!games.length){
      try{ const box = await fetchAny('boxscore.json'); const g = box.game || box; games = [g]; dbg('Fallback: single boxscore loaded'); } catch(e){ showEmpty(host,'No games available to aggregate','Upload games.json with multiple entries or a boxscore.json'); return; }
    }

    const playersAgg = aggregatePlayersFromGames(games);
    if(!playersAgg.length){ showEmpty(host,'No players found across games','Ensure home.players and away.players exist in each game'); return; }

    // categories: totals and per-game leaders
    const catsSeason = [
      ['TOTAL POINTS','pts',0, p=>p.pts],
      ['POINTS PER GAME','ppg',1, p=>p.ppg],
      ['TOTAL REBOUNDS','reb',0, p=>p.reb],
      ['REBOUNDS PER GAME','rpg',1, p=>p.rpg],
      ['TOTAL ASSISTS','ast',0, p=>p.ast],
      ['ASSISTS PER GAME','apg',1, p=>p.apg],
      ['3-PT MADE (TOTAL)','tpm',0, p=>p.tpm],
      ['3-PT MADE (per game)','tpm_pg',1, p=>p.tpm_pg]
    ];

    for(const [label,key,dp,fn] of catsSeason){
      const top = [...playersAgg].sort((a,b)=> (fn(b)??0) - (fn(a)??0)).slice(0,8).map(p=>({ name: p.name + ' • ' + p.team, val: round(fn(p), dp) }));
      renderCard(host, label, top);
    }

  }

  run();

})();
</script>
</body></html>